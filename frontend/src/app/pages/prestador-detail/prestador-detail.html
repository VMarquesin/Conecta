<div class="profile-container">

  @if (prestador$ | async; as prestador) {
    <div class="profile-header">
      <h2>{{ prestador.nomeCompleto }}</h2>
      <p class="fantasia">{{ prestador.nomeFantasia }}</p>
      <p class="bio">{{ prestador.bio }}</p>
      <p class="contato">Contato: {{ prestador.email }}</p>
    </div>
  } @else {
    <p>Carregando perfil...</p>
  }

  <div class="section">
    <h3>Portfólio (Publicações)</h3>
    
    <div class="publicacoes-grid">
      @for (pub of (publicacoes$ | async); track pub.id) {
        <div class="pub-card">
          
          @if(pub.fotoUrl) {
            <img [src]="pub.fotoUrl" alt="Foto da Publicação" />
          }
          <h4>{{ pub.titulo }}</h4>
          <p>{{ pub.descricao }}</p>
          <small>{{ pub.dataPublicacao | date : 'dd/MM/yyyy' }}</small>

          @if (isLoggedIn$ | async) {
            @if (authService.hasRole('ROLE_CLIENTE')) {
              <button class="btn-avaliar-pub" (click)="toggleAvaliacaoPublicacao(pub.id)">
                @if (publicacaoAbertaParaAvaliar === pub.id) {
                  Fechar Avaliação
                } @else {
                  Avaliar Publicação
                }
              </button>
            }
          }

          @if (publicacaoAbertaParaAvaliar === pub.id) {
            <form [formGroup]="pubAvaliacaoForm" (ngSubmit)="onPostarAvaliacaoPublicacao(pub.id)" class="form-container-inline">
              </form>
          }
        </div>
      } @empty {
        <p>Este prestador ainda não tem publicações.</p>
      }
    </div>
  </div>

  <div class="section">
    <h3>Avaliações do Prestador</h3>
    <div class="avaliacoes-list">
      @for (aval of (avaliacoes$ | async); track aval.id) {
        <div class="aval-card">
          @if (isLoggedIn$ | async) { @if (authService.hasRole('ROLE_CLIENTE')) {
            <button class="btn-delete" (click)="onDeletarAvaliacao(aval.id)">X</button>
            <button class="btn-edit" (click)="onCarregarAvaliacaoParaEditar(aval)">Editar</button>
          }}
          <div class="nota">Nota: {{ aval.nota }} / 5</div>
          <p>"{{ aval.comentario }}"</p>
          <small>- {{ aval.nomeCliente }} em {{ aval.dataAvaliacao | date : 'dd/MM/yyyy' }}</small>
        </div>
      } @empty {
        <p>Este prestador ainda não foi avaliado.</p>
      }
    </div>
  </div>

  <div class="section form-container">
    @if (isLoggedIn$ | async) { @if (authService.hasRole('ROLE_CLIENTE')) {
      <h3>
        {{ editandoAvaliacaoId ? 'Editar Avaliação' : 'Deixe sua Avaliação (para o Prestador)' }}
      </h3>
      <form [formGroup]="avaliacaoForm" (ngSubmit)="onPostarAvaliacao()">
        
        <button type="submit" [disabled]="avaliacaoForm.invalid">
          {{ editandoAvaliacaoId ? 'Salvar Alterações' : 'Postar Avaliação' }}
        </button>
        @if (editandoAvaliacaoId) {
          <button type="button" class="btn-cancel" (click)="cancelarEdicaoAvaliacao()">Cancelar</button>
        } 
        @if (mensagemSucesso) {
          <div class="success-message">{{ mensagemSucesso }}</div>
        }
      </form>
    } } @else {
      <p>
        Você precisa estar logado para deixar uma avaliação.
        <a routerLink="/login">Faça o login aqui.</a>
      </p>
    }
  </div>
</div>