<div class="perfil-container">

  <details class="profile-accordion">
    <summary>Gerenciar Informações do Perfil</summary>
    
    <div class="form-container" style="border-top: 1px solid var(--cor-borda);">
      @if (perfil$ | async; as perfil) {
        
        <form [formGroup]="perfilForm" (ngSubmit)="onSalvarAlteracoes()">
          
          @if (isPrestador) {
            <h2>Editar Perfil de Prestador</h2>
            <div class="form-group">
              <label for="nomeFantasia">Nome Fantasia</label>
              <input id="nomeFantasia" type="text" formControlName="nomeFantasia">
            </div>
            <div class="form-group">
              <label for="bio">Minha Bio (Descrição do Perfil)</label>
              <textarea id="bio" formControlName="bio" rows="4"></textarea>
            </div>
          } @else {
            <h2>Editar Perfil de Cliente</h2>
          }
          <hr>
          <h4>Informações da Conta</h4>
          <div class="form-group">
            <label for="nomeCompleto">Nome Completo</label>
            <input id="nomeCompleto" type="text" formControlName="nomeCompleto">
          </div>
          <div class="form-group">
            <label for="email">Email (não pode ser alterado)</label>
            <input id="email" type="email" formControlName="email" [readOnly]="true">
          </div>
          <div class="form-group">
            <label for="cpf">CPF (não pode ser alterado)</label>
            <input id="cpf" type="text" formControlName="cpf" [readOnly]="true">
          </div>
          
          <button type="submit">Salvar Alterações</button>
          
          @if (mensagemSucesso) {
            <div class="success-message" style="margin-top: 1rem;">
              {{ mensagemSucesso }}
            </div>
          }
        </form>
        
      } @else {
        <p>Carregando perfil...</p>
      }
    </div>
  </details>

  @if (isPrestador) {
    <div class="section">
      <h3>Meu Portfólio (Publicações)</h3>

      <div class="form-container" style="margin-bottom: 2rem; background-color: #f9f9f9;">
        <h4>{{ editandoPublicacaoId ? 'Editar Publicação' : 'Adicionar Novo Item' }}</h4>
        <form [formGroup]="publicacaoForm" (ngSubmit)="onPostarPublicacao()">
          <div class="form-group">
            <label for="titulo">Título</label>
            <input id="titulo" type="text" formControlName="titulo" />
            @if (publicacaoForm.get('titulo')?.invalid && publicacaoForm.get('titulo')?.touched) {
              <div class="error-message">Título é obrigatório.</div>
            }
          </div>
          <div class="form-group">
            <label for="descricao">Descrição</label>
            <textarea id="descricao" formControlName="descricao" rows="3"></textarea>
            @if (publicacaoForm.get('descricao')?.invalid && publicacaoForm.get('descricao')?.touched) {
              <div class="error-message">Descrição é obrigatória.</div>
            }
          </div>
          <div class="form-group">
            <label for="fotoUrl">URL da Foto (opcional)</label>
            <input id="fotoUrl" type="text" formControlName="fotoUrl" placeholder="http://exemplo.com/imagem.png" />
          </div>
          <button type="submit" [disabled]="publicacaoForm.invalid">
            {{ editandoPublicacaoId ? 'Salvar alterações' : 'Postar' }}
          </button>
          @if (editandoPublicacaoId) {
            <button type="button" class="btn-cancel" (click)="cancelarEdicao()">Cancelar edição</button>
          } 
          @if (mensagemSucessoPublicacao) {
            <div class="success-message">{{ mensagemSucessoPublicacao }}</div>
          }
        </form>
      </div>

      <div class="publicacoes-grid">
        @for (pub of (publicacoes$ | async); track pub.id) {
          <div class="pub-card">
            <button type="button" class="btn-delete" (click)="onDeletarPublicacao(pub.id)">&#10006;</button>
            <button type="button" class="btn-edit" (click)="onCarregarParaEditar(pub)">&#9998;</button>

            @if(pub.fotoUrl) {
              <img [src]="pub.fotoUrl" alt="Foto da Publicação" />
            } @else {
              <div class="no-photo-placeholder">Sem Imagem</div>
            }
            <h4>{{ pub.titulo }}</h4>
            <p>{{ pub.descricao }}</p>
            <small>{{ pub.dataPublicacao | date : 'dd/MM/yyyy' }}</small>
          </div>
        } @empty {
          <p>Você ainda não tem publicações. Crie sua primeira no formulário acima!</p>
        }
      </div>
    </div>
  }
</div>